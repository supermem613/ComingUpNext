name: Release MSI

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'src/ComingUpNextTray/ComingUpNextTray.csproj'

permissions:
  contents: write

jobs:
  release:
    runs-on: windows-latest
    env:
      PROJECT_CSProj: src/ComingUpNextTray/ComingUpNextTray.csproj
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '9.0.x'

      - name: Extract version from csproj
          id: version
          shell: pwsh
          run: |
            Write-Host "Reading version from $env:PROJECT_CSProj"
            $content = Get-Content $env:PROJECT_CSProj -Raw
            if (-not $content) { Write-Error 'Could not read csproj content.' }
            try {
              [xml]$xml = $content
            } catch {
              Write-Warning 'XML parse failed, will try regex.'
            }
            $v = $null
            if ($xml) {
              # Handle multiple PropertyGroup elements
              $v = ($xml.Project.PropertyGroup | ForEach-Object { $_.Version } | Where-Object { $_ } | Select-Object -First 1)
            }
            if (-not $v) {
              if ($content -match '<Version>(?<ver>[^<]+)</Version>') {
                $v = $Matches.ver
                Write-Host 'Version found via regex fallback.'
              }
            }
            if (-not $v) { Write-Error 'Version element not found in csproj.' }
            $v = $v.Trim()
            if (-not $v) { Write-Error 'Version value is empty after trim.' }
            Write-Host "Version: $v"
            "version=$v" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: Restore NuGet packages
        run: dotnet restore ComingUpNext.sln

      - name: Build solution (Release)
        run: dotnet build ComingUpNext.sln --configuration Release --no-restore

      - name: Fail build on warnings (treat warnings as errors)
        run: dotnet build ComingUpNext.sln --configuration Release --no-restore --warnaserror

      - name: Build MSI
        shell: pwsh
        run: |
          cd installer
          ./build.ps1 -Configuration Release -Version ${{ steps.version.outputs.version }}

      - name: Publish MSI artifact
        uses: actions/upload-artifact@v4
        with:
          name: MSI
          path: installer/publish/*.msi

      - name: Create or Update GitHub Release
        uses: ncipollo/release-action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag: v${{ steps.version.outputs.version }}
          name: ComingUpNextTray v${{ steps.version.outputs.version }}
          allowUpdates: true
          replacesArtifacts: true
          generateReleaseNotes: true
          artifacts: installer/publish/*.msi